#!/usr/bin/env ruby

# Ingest a given repo into the development clickhouse database

repo = ARGV.first

abort "Error: Must provide a repo to ingest" unless repo
abort "Error: Path 'tokei/#{repo}' doesn't exist" unless Dir.exist?(repo)

query = "INSERT INTO evolution_development.code_files (* EXCEPT(created_at)) FORMAT TSV"
sorted_tsvs = Dir.glob("tokei/#{repo}/*.tsv").sort

sorted_tsvs.each do |path|
  puts "Ingesting #{path}"
  result = `cat #{path} | clickhouse-client --query="#{query}"`
  puts result
end
