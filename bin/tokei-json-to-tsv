#!/usr/bin/env ruby

require "active_support/core_ext/string/inflections"

path = ARGV.first

raise "Please provide a path to tokei json output!" unless path

require "simdjson"

puts "Reading #{path}"
_, repo, filename = path.split("/") # path format: "tokei/<repo-name>/<date>.json"
date = filename.delete_suffix(".json")
tokei_json = Simdjson.parse(File.read(path))
output_path = path.delete_suffix(".json") + ".tsv"

tsv = tokei_json.flat_map do |language, content|
  content.fetch("reports").map do |report|
    path = report.fetch("name")
    stats = report.fetch("stats")

    [
      repo,
      date,
      path,
      language,
      stats.fetch("blanks"),
      stats.fetch("code"),
      stats.fetch("comments"),
      stats.fetch("blanks") + stats.fetch("code") + stats.fetch("comments"),
    ].join("\t")
  end
end.join("\n")

puts "Writing #{output_path}"
File.open(output_path, "w") do |file|
  file.write(tsv)
end
