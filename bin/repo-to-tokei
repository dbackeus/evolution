#!/usr/bin/env ruby

require "date"
require "fileutils"
require "active_support/all"

repo_path = ARGV.first

abort "Error: Please provide a directory path as argument" unless repo_path
abort "Error: '#{repo_path}' is not a directory" unless Dir.exist?(repo_path)

repo_name = File.basename(repo_path)
FileUtils.mkdir_p "tokei/#{repo_name}"
cwd = Dir.pwd

Dir.chdir(repo_path) do
  system "git checkout master", exception: true

  # first_date = Time.at(`git log --reverse --format=%ct | head -n 1`.to_i).to_date
  last_date = Time.at(`git log -1 --format=%ct`.to_i).to_date

  # Performance on mynewsdesk: approx 4 days per second
  # Performance on mnd-audience: approx 14 days per second
  count = 0
  current_date = last_date
  loop do
    count += 1
    sha = `git rev-list -n 1 --before="#{current_date} 23:59:59" master`

    break if sha.empty?

    system "git checkout #{sha}", exception: true # raise if we fail to checkout

    sha_date = Time.at(`git log -1 --format=%ct`.to_i).to_date

    puts "Day #{count}, date #{sha_date}"

    system "tokei -e vendor -e tmp -e node_modules --output json > #{cwd}/tokei/#{repo_name}/#{sha_date}.json"

    current_date = sha_date - 1
  end

  system "git checkout master", exception: true
end

puts "Created tokei dumps in tokei/#{repo_name}"
